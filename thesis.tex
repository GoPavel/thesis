\documentclass[times
              %,specification
              %,annotation
              ]{itmo-student-thesis}

\usepackage{amssymb}
\usepackage{mathtools}

\begin{document}
\studygroup{M3439}
\title{Применение теории Клини и ее расширений для автоматизации доказательств в системе Coq  }
\author{Головин Павел Андреевич}{Головин П. А.}
\supervisor{TODO}{TODO}{проф., д.т.н.}{главный научный сотрудник Университета ИТМО}
\publishyear{2020}
%% Дата выдачи задания. Можно не указывать, тогда надо будет заполнить от руки.
%\startdate{01}{сентября}{2018}
%% Срок сдачи студентом работы. Можно не указывать, тогда надо будет заполнить от руки.
%\finishdate{31}{мая}{2019}
%% Дата защиты. Можно не указывать, тогда надо будет заполнить от руки.
%\defencedate{15}{июня}{2019}

%\addconsultant{Белашенков Н.Р.}{канд. физ.-мат. наук, без звания}
%\addconsultant{Беззубик В.В.}{без степени, без звания}

\secretary{Павлова О.Н.}

%% Задание
%%% Техническое задание и исходные данные к работе
\technicalspec{TODO}

%%% Содержание выпускной квалификационной работы (перечень подлежащих разработке вопросов)
\plannedcontents{TODO}

%%% Исходные материалы и пособия
\plannedsources{\begin{enumerate}
    \item TODO
\end{enumerate}}

%%% Цель исследования
\researchaim{TODO}

%%% Задачи, решаемые в ВКР
\researchtargets{\begin{enumerate}
    \item TODO
\end{enumerate}}

%%% Использование современных пакетов компьютерных программ и технологий
%\addadvancedsoftware{Пакет \texttt{tabularx} для чуть более продвинутых таблиц}{\ref{sec:tables}, Приложения~\ref{sec:app:1}, \ref{sec:app:2}}
%\addadvancedsoftware{Пакет \texttt{biblatex} и программное средство \texttt{biber}}{Список использованных источников}

%%% Краткая характеристика полученных результатов
\researchsummary{TODO}

%%% Гранты, полученные при выполнении работы
\researchfunding{TODO}

%%% Наличие публикаций и выступлений на конференциях по теме выпускной работы
\researchpublications{TODO
%  \begin{refsection}
%    Однако покажу, как можно ссылаться на свои публикации из списка литературы:
%    \nocite{example-english, example-russian}
%    \printannobibliography
%  \end{refsection}
}

%% Эта команда генерирует титульный лист и аннотацию.
\maketitle{Бакалавр}

%% Оглавление
\tableofcontents

%% Макрос для введения. Совместим со старым стилевиком.
\startprefacepage

%:Needs:
%      Актуальность работы
%      Цели и задачи работы
%      Новизна работы
%      Практическое значение работы
%      Ссылки на доклады и публикации
%      Краткое описание структуры работы по главам

% ASK Можно ли делать ссылки в введении?

Сегодня компьютерные программы играют большую роль в нашей жизни и все чаще затрагивают такие области как медицина, энергетика, финансы, машиностроение и другие, где огромную роль играет корректность кода.

За последние годы был достигнут большой прогресс в области построения систем интерактивного доказательства теорем, которые позволяют формально верифицировать программы.
Пользователь такой системы должен сначала формализовать программу и ее спецификацию, а потом с помощью специального языка написать доказательство, которое система проверит на корректность.
Примерам таких систем являются Coq(link?), Agda(link?), Isabelle/HOL(link), Idris(link?).

Coq - это один из таких инструментов, который имеет наиболее развитую экосистему и большое сообщество.
Он часто используется для создания верифицированных систем, связанных с компиляцией языков программирования(link to CompCert, Haskell Core Spec, Vellvm) и, в частности, для формализации слабых моделей памяти (link to Victor, Anton).

Модель памяти языка программирования призвана специфицировать поведения параллельных программ в присутствии гонок по данным.
Простые модели памяти могут просто запрещать гонки или гарантировать последовательную согласованность всех операций в программе.

Но такой подход сильно ограничивает параллелизм и мешает компилятору оптимизировать код, от чего сильно страдает производительность программ.
Поэтому на сегодняшний день все языки используют более слабые ограничения (слабые модели памяти).

Такие модели используют бинарные отношения на элементарных событиях чтения и записи, например, отношение синхронизации на атомарных переменных, чтобы выделить только конфликтующие операции и наложить ограничения на возможные исполнения программы.

Проблема заключается в том, что создание формальной слабой модели памяти, которая корректно применима при компиляции программы под разные архитектуры - очень сложная задача, требующая объемных доказательств с аккуратным рассмотрением большого количества случаев.
Поэтому при разработке современных моделей памяти стараются использовать системы интерактивного доказательства теорем (RC11 link?), чтобы упростить написание и проверку доказательств с помощью компьютера.

Так как, работая со слабыми моделям памяти, мы часто имеем дело с бинарными отношениями, то можно попробовать обобщить и вынести (автоматизировать) доказательства утверждений связанные с их свойствами.
Это должно облегчить разработку и исследование слабых моделей памяти в системе Coq.

Алгебра Клини - это алгебраическое обобщение бинарных отношений, регулярных выражений и некоторых других похожих конструкций.
Эта теория хорошо изучена и имеет ряд интересных расширений.
% TODO: Нужны ли тут линки на интересные расширения?

Цель данной работы заключается исследовании перспективности использования Теории алгебры Клини для упрощения формальных доказательств в системе Coq связанных с моделями памяти.
% TODO Альтенативный финал: (Не понятно пока как лучше сформулировать (trade off))
% Цель данной работы заключается исследовании перспективности использования Теории алгебры Клини для упрощения формальных доказательств свойст бинарных отношений в системе Coq.


%% Начало содержательной части.
\chapter{Первая глава}
  % NOTE Первая глава носит обзорны характер.
  %      Тут нужно раскрыть введение и дать точное представление о поставленной задачи
  %      Тут должно быть большинство ссылок на различные источники
  \section{Описание предметной области}

  % План: рассказать, что такое алгебра КАТ, рассказать что про

    \subsection{Алгебра отношений}
      Для некоторого множества $ O $, зададим \textit{бинарные отношения}
      $ a, b \subseteq \mathcal{P}(O \times O) $
      и операциями над ними:
      \begin{itemize}
        \item композиция:
         $$a \cdot b \coloneqq
        \{ (x, y) : \exists z : (x, z) \in a, (z, y) \in b \} $$
        и нейтральном элементом $ 1 := \{(x, x) : x \in O\}$
        % \item композиции ($ \cdot $) и нейтральным элементом <<$1$>>
        \item рефлексивного транзитивного замыкания:
        $$ a^* \coloneqq \bigcup\limits_{n \in \overline{0..n}} a^n $$,
       где
       \begin{equation*}
        a^n = \begin{cases}
          a^{n-1} \cdot a & n > 1\\
          a               & n = 1\\
          1               & n = 0
        \end{cases}
       \end{equation*}
      \end{itemize}

      \textit{Алгеброй отношений} $\mathit{Rel}\langle O \rangle$
      назовем кортеж  $\langle O, 1, \cdot, \_^* \rangle $
      Также часто алгебра дополняется:
      \begin{itemize}
        \item транзитивным замыканием:
        $$ a^+ = \bigcup\limits_{n \in \overline{1..n}} a^n $$
        \item пересечением и объединением:
        $$ a \cap b = \{(x, y) : (x, y) \in a, (x, y) \in b \} $$
        $$ a \cup b = \{(x, y) : (x, y) \in a ~\text{или}~ (x, y) \in b   \} $$
        \item инвертированием:
         $$ a^\smile \coloneqq \{ (y, x): (x, y) \in a \} $$
        \item пустым отношением $ 0 \coloneqq \emptyset $
        \item универсальным множеством: $ \top \coloneqq \mathcal{P}(O \times O) $
      \end{itemize}

      Заметим, $ \mathit{Rel} \langle O \rangle $ замкнута относительно всех этим операций.

      \textit{Расширенной алгеброй отношений} назовем структуру алгебру отношений с некоторыми из этих операций. Далее мы будем использовать термин <<\textit{алгебра отношений}>> как синоним расширенной алгебры отношений, понимая какие операции заданы из контекста.


      Для любых двух выражений $ f, e \in \mathit{Rel}$ определим выражение равенства $ f = e $ и неравенства $ f \leq e $, как теоретико-множественные операции равенства и включения множеств соответственно.

      Обозначим за $\mathit{Rel}$ - класс алгебр $ \mathit{Rel}\langle O \rangle $ для всех $ O $.

      Для определения оценки выражения введем еще несколько обозначений:
      \begin{itemize}
        \item конечный алфавит $ \Sigma $
        \item выражения $ f, e $ состоящие из конечного количества связок
        ($ \cdot, \_^*, \_^+, \cap, \cup, \_^{\smile}, 1, 0, \top $) и атомарных переменных из алфавит $ \Sigma $.
        \item элементарную функцию оценки S, которая сопоставляет атомарным переменным некоторые бинарные отношения из алгебры $ R \langle O \rangle $.
      \end{itemize}
      Тогда (не)равенство выражений $ f $ и $ g $ является \textit{общезначимым в классе алгебр отношений}
      ($\mathit{Rel} \models f \leq g, \mathit{Rel} \models f = g $),
      если после оценки переменных любой функцией $ S $ для любой алгебры $ \mathit{Rel}\langle O \rangle $ получается верное равенство бинарных отношений.

    \subsection{Моноид, группа и идемпотентное полу-кольцо}
      Назовем кортеж $ \langle A, \cdot, 1 \rangle $ - \textit{моноидом}, если выполняются следующие правила:
      $$ x \cdot (y \cdot z) = (x \cdot y) \cdot z \;\;\;\;\;
         x \cdot 1 = x \;\;\;\;\;
         1 \cdot x = x
      $$
      Так же будем говорить что моноид \textit{коммутативный} если выполнено:
      $$ x \cdot y = y \cdot x $$
      и \textit{идемпотентный} если:
      $$ x \cdot x = x $$

      Если же в для моноида $ \langle A, \cdot, 1 \rangle $ назад обратная операция $ \_^{-1} $ удовлетворяющая свойствам:
      $$ x \cdot x^{-1} = 1 \;\;\;\;\;
         x^{-1} \cdot x = 1
      $$
      то назовем кортеж $ \langle A, \cdot, 1, \_^{-1}\rangle $ - \textit{группой}

      Определим \textit{идемпотентное полу-кольцо} как кортеж $ \langle A,+,\cdot,\_^*,0,1 \rangle$ для которого верно, что
      $ \langle A, \cdot, 1 \rangle $ - моноид,
      а $ \langle A, +, 0 \rangle $ - коммутативный моноид и выполнены следующий правила:
      $$ a \cdot (b + c) = (a \cdot b) + (a \cdot c) \;\;\;\;\;
         (a + b) \cdot c = (a \cdot c) + (b \cdot c) \;\;\;\;\;
         0 \cdot a = 0
      $$

    \subsection{Алгебра Клини}
      % TODO (линк на Algebra of Relation)

      Назовем \textit{Алгеброй Клини} кортеж $\langle A,+,\cdot,\_^*,0,1\rangle$ такой, что $\langle A, +, \cdot, 0, 1 \rangle$ - идемпотентное полу-кольцо и операция $ \_^* $ удовлетворяет ряду аксиом:
      \begin{enumerate}
        \item $ 1 + a \cdot a^* \leq a^* $
        \item $ 1 + a^* \cdot a \leq a^* $
        \item $ b + a \cdot x \leq x \Rightarrow a^* \cdot b \leq x $
        \item $ b + x \cdot a \leq x \Rightarrow b \cdot a^* \leq x $
      \end{enumerate}
      где  $ a \leq b \coloneqq a + b = b$

      Тогда за $ \mathit{KA} $ обозначим аксиоматизированную теорию, состоящую аксиом идемпотентного полу-кольца и аксиом (а-г).

      Записью $ \mathit{KA} \vdash f = g $ будем обозначать факт, что равенство $ f = g $, является логическим следствием аксиом $ \mathit{KA} $,
      аналогично $ \mathit{KA} \vdash f \leq g $.

      Известно, что теория алгебры Клини разрешима и полна относительно алгебры отношений
      ($ Rel \models f = g \Leftrightarrow \mathit{KA} \vdash f = g$) (link?).
      Это позволяет доказывать общезначимость равенств бинарных отношений через проверку выводимости в $ \mathit{KA} $.

    \subsection{Алгебра Клини с тестами}
      Теперь рассмотрим очень полезное расширение KA, алгебры Клини с тестами.

      \textit{Клини алгебра с тестами}, это кортеж $\langle K,\mathbb{B}, [\cdot] \rangle$ такой, что:

      \begin{itemize}
        \item $K$ - Клини алгебра $\langle A, +, \cdot, \_^*, 0, 1 \rangle $
        \item $\mathbb{B}$ - булева алгебра $\langle B, \wedge, \vee, \neg, \top, \bot \rangle $
        \item $[\cdot]$ - гомоморфизм из
          $\langle B, \vee, \wedge, \top, \bot \rangle$
        в $\langle A, +,     \cdot, 1,    0 \rangle$
      \end{itemize}
      % TODO надо ли сказать, что такое гомоморфизм?

      Аналогично расширим определение бинарных отношений $Rel \langle O \rangle $, добавив булеву алгебру $\langle \mathcal{P}\langle O \rangle, \cap, \cup, O, \emptyset \rangle$ и гомоморфизм $ [a] = \{(x, x): x \in a\} $.

      За $ \mathit{KAT} $ обозначим аксиоматическую теорию, состоящую из аксиом \textit{KA}, булевой алгебры $ \mathbb{B}$ и свойств гомоморфизма. И аналогично обозначим за $ KAT \vdash f = g, f \leq g $ выводимость в этой теории.

      Алгебра Клини с тестами полна относительно такой расширенной алгебры бинарных отношений.
      ($\mathit{KAT} \vdash f = g \Leftrightarrow \mathit{Rel} \models f = g$) (link?)
      % TODO (link)

      Элементы булевой алгебры называют обычно называются тестами.
      Гомоморфизм отображает их в множество петель, конкатенация с которыми позволяет "фильтровать" отношения по условию принадлежности к тесту.

      Это позволяют обогатить бинарные отношения предикатами на доменах отношений.

    \subsection{Алгебры Клини с инверсией}
      Если добавим к алгебре Клини операцию инвертирования $ \_^{\smile} $, удовлетворяющую следующим аксиомам:
      \begin{enumerate}
        \item $ (a + b)^{\smile} = a^{\smile} + b^{\smile} $
        \item $ (a \cdot b)^{\smile} = b^{\smile} \cdot a^{\smile} $
        \item $ (a^*)^{\smile} = (a^{\smile})^* $
        \item $ {a^{\smile}}^{\smile} = a $
        \item $ a \leq a \cdot a^{\smile} \cdot a $
      \end{enumerate}
    тогда мы получим теорию называемую \textit{Алгебрами Клини с инверсией} (\textit{KAC}).
    В ней аналогично с \textit{KA} определяются (не)равенства, оценки и выводимость.

    \textit{KAC} разрешима и полна относительно бинарных отношений, но не полна относительно регулярных языков, где инверсия задается как "переворачивание" слов.
    В частности аксиома (д) в них необщезначима.

      % TODO Definition Coq
      % TODO Definition KL, KL_
      % TODO Defintion KAl
  \subsection{Тактики Coq}
    Доказательства с системе Coq записываются как последовательность команд, которые изменяют текущее целевое утверждение. Такие команды называются \textit{тактики}.

    Тактики могут применять аксиомы, гипотезы, переписывать подвыражения используя уже доказанные равенства, разбивать доказательство на случаи и даже целиком доказывать текущее утверждение.

  \subsection{Средства обобщения и перегрузки доказательств в Coq}

    В Coq есть несколько механизмов, которые позволяют обобщать и переиспользовать доказательства и определения.
    В данной работе упоминаются \textit{классы типов} и \textit{канонический структуры}.

    Не смотря на тонкие различия между этими инструментами, оба они используются чтобы, задать интерфейс некоторого сетоида, то есть семейство типов снабженное некоторыми операциями и свойствами.
    Далее мы можем опираясь на описанные в интерфейсе свойства доказывать утверждения, которые будут верные для любого типа, который выходит в это семейство.

    Чтобы кто-то смог воспользоваться этими утверждениями для конкретного типа, ему необходимо объявить свой тип экземпляром этого семейства и доказать, что он отвечает всем его свойствам.

   %TODO: может стоит так же дополнительно отметить, что тут очень важно, что инстансы выводятся автоматичски (в нормальных случаях).

  \section{Анализ}
     % TODO Что требуется для достижения цели
     % TODO Что уже сделано
     % TODO Почему сделанного недостаточно

  % Нужно ли писать, что-то про Coq? Наверно нет, это будет ниже

  \subsection{Анализ различных расширений алгебр Клини}
    Рассмотрим как расширения теории алгебр Клини могут быть использованы в формализации слабых моделей памяти.

    Алгебра Клини будет полезна, чтобы автоматически доказывать утверждения об отношениях между событиями,
    содержащих операции $ \cup, \cdot, \_^* $, а также $0, 1 $ и их производные.
    Например, утверждении о том, что отношение $ r $ рефлексивно замкнуто мы можем записать как $ r = r \cup 1 $.

    Алгебра Клини с тестами позволяет накладывать ограничения домены отношения, то есть на события. Это позволяет нам, например, связать операции чтения и записи:
    $ \text{rf} = [W] \cdot \text{rf} \cdot [R] $,
      где rf - это отношение <<read from>>,
      а $W$/$R$ - множество событий записи/чтения.

%     Это дает нам возможность выразить переход между фиксированными командами $ a $ и $ b $:
%    $ [\lambda x, x = a]\cdot 1 \cdot[\lambda x, x =b] $. Или например факт того, что если какое-то утверждение $ d $ верно в домене, то будет верно и на кодомене отношения можно выразить так: $ [!d] \cdot r \cdot [d] \subseteq 0 $

    В моделях памяти ограничение на исполнение программы часто формулируется как ацикличность комбинации некоторых отношений: порядка команд в тексте программы, отношение синхронизации на атомарных объектах и т. д.
    Но чтобы выразить ацикличность через алгебру Клини нам необходимо добавить операцию пересечения ($\cap$).
    Тогда ацикличность могла бы выглядеть так: $ r^* \cap 1 \subseteq 0 $.

    % TODO: надо наверно вынести это в секцию определения KL
    Добавление этой операции делает из нашей алгебры решетку, поэтому такое расширение принято называть Решетки Клини (\textit{KL}).
    Но проблема в том, алгоритм проверки доказуемости при этом становится EXPSpace-полным(link?).
    Конечные детерминированные автоматы, как и регулярные языки с пересечением не полны относительно алгебры отношений.
    Это заставляет придумывать более сложные конструкции для построения алгоритма вывода, такие как автоматы Петри (link?), что сильно усложняет формализацию алгоритма в Coq.

    Поэтому этому пока нет возможности автоматически доказывать утверждения требующие пересечения отношений.
    %TODO где надо это доказывать? И надо ли?

    Иногда в моделях памяти возникают функциональные отношения, то есть те которые являются частичными функциями. Свойство, что отношение $ r $ является функциональным можно выразить в \textit{KAC} с помощью операции инвертирования ($ \_^{\smile} $) как $ r^{\smile} \cdot r \leq 1 $.
    % TODO Написать нормальный пример.

  \subsection{Анализ существующих реализаций в Coq}

    После анализа уже существующих формализаций алгебр Клини в Coq, были найдены две библиотеки ATRB(link) и relation-algebra(link).
    % TODO: правда ли, что для клини алгебры есть только эти две бибилиотеки в Coq?

    ATRB - это ранняя версия relation-algebra, которая предоставляла тактики для автоматического доказательства (не)равенств в \textit{KA} и \textit{KAC}.
    К сожалению, для \textit{KAC} поддерживается только модель регулярный языков, но не бинарных отношений.
    Так же изначальный дизайн библиотеки и производительность классов типов в Coq стали критическим препятствиями для модернизации библиотеки,
    в частности для добавления поддержки \textit{KAT}.
    Поэтому авторы решили переписать библиотеку с нуля, обобщив дизайн и используя другой механизм вывода типов - канонический структуры.

    В relation-algebra реализована полная поддержка \textit{KAT} и определена тактика \textbf{kat}, которая позволяет автоматически доказывать (не)равенства.
    Так же она как и ATRB доставляет тактику для \textit{KA} - \textbf{ka}.

    Главная особенность этой библиотеки - это тактика \textbf{hkat}, которая позволяет строить доказательство, используя гипотезы Хора ($ f \leq 0 $).

    Это чрезвычайно полезно на практике.
    Например, мы можем доказывать монотонность некоторые свойств отношений,
    то есть если факт того, что если для двух отношений свойство выполняется, то и для их комбинации оно тоже будет выполнено.

    В качестве интерфейса библиотека предоставляет каноническую структуру \textit{KAT} с определением сигнатуры всех операций и класс типов с набором аксиом для них.

  \section{Постановка задачи}
    % NOTE Текст здесь должен следовать из цели (см. введение)
    % TODO Возможно формулировка того, где мы применяем KAT надо обобщить ?
    % TODO Надо тут сформулировать что-то, к чему потом будет теоритическоре решение
    Необходимо исследовать применимость расширений Теории алгебр Клини, в частности \textit{KAT}, в доказательствах связанных с моделями памяти.
    Для эксперимента была взята библиотека hahn(link?), которая является базовой для формализации разных слабых моделей памяти.
    % TODO link to hahn, add someting

  \section{Выводы из первой главы}
    В данной главе было сделано введение в предметную область, в которой была выполнена работа,
    а также была проанализирована и сформулирована задача для дальнейшего решения.
\chapter{Вторая глава}
 % Needs:
 % TODO Предполагаемое теоретическое решение
 % TODO Обоснование, почему оно удовлетворяет треботваниям, сформулированным в первой главе
 % TODO Теоретическое сравнение с существующими решениями

  \section{Описание решения проблемы}

    \subsection{Определение экземпляра \textit{KAT}}
    % TODO Я не понимаю, стоит ли использоват тут прошлое время. С одной стороны как бы тут итоговое наше решение, а с другой в 3ей главе описывается как это реализуется на практике.
    Чтобы использовать тактики \textbf{kat}/\textbf{hkat} для автоматизации доказательств,
    тип бинарных отношений и предикаты на доменах, который используются в hahn, были объявлены экземпляром канонической структуры \textit{KAT}.
    А также было доказано, что все аксиомы для этого типа выполняются и объявлен экземпляр класса типов содержащий эти доказательства.

   % Необходимо выполнение всех аксиом в \textit{KAT} для определения бинарных отношений которые используются в hahn. Для этого можно использовать стандартные средства интерактивного доказательства которые предоставляет Coq и леммы из relation-algebra.
   % Например, в библиотеке уже имеется доказательства того, что встроенный в Coq тип утверждений Prop отвечает аксиомам булевой алгебры, а также лемму о том, что мы можем поточечно расширять алгебраическую структуру. Применив эту лемму к булевой алгебре Prop, мы получим булеву алгебру предикатов $ A \rightarrow Prop $. А применив второй раз, мы получим как раз определения бинарных отношений в hahn $ A \rightarrow A \rightarrow Prop $.

    \subsection{Переформулировка определений}
   Чтобы доказывать некоторые утверждения и использовать их в качестве гипотез, необходимо чтобы они были сформулированы в терминах бинарных отношений с тестами.
   Если утверждение не отвечает этому критерию, выразим свойство в сигнатуре \textit{KAT} и докажем, что новое определение эквивалентно в логическом смысле существующему.

   Например, $max\_elt\ a\ r$ - утверждение, что $a$ является максимальным событием в отношении $r$ определяется следующим образом:
   % TODO опции float???
   \begin{lstlisting}[mathescape=true, language=haskell]
     Definition max_elt {A: Type} (r: relation) (a: A) :=
       $\forall (b: A)\ (REL: r\ a\ b), \bot$
   \end{lstlisting}

   Переформулируем: так как $ a $ - максимальный элемент, отношения которое начинается в $ a $ и переходит по $ r $ должно быть пусто (иначе кодомен $ r $ будет больше).

   Поэтому докажем лемму:
   \begin{lstlisting}[mathescape=true, language=haskell]
     Lemma max_elt_iff_kat {A: Type} (a: A) (r: relation A),
       max_elt r a $ \leftrightarrow [\lambda b \Rightarrow a = b] \cdot r \subseteq \emptyset$
   \end{lstlisting}

    Теперь когда нам нужно доказывать или использовать как гипотезу утверждение $ max\_elt\ r\ a $
    мы можем встроенными средствами Coq(тактикой rewrite) заменить его на $ KAT $-выражение.

    Благодаря такому подходу мы можем не переписывать определения всех теорем и лемм, а изменить только доказательства их.
    Это сохранит интерфейс библиотеки hahn и не сломает нетронутых доказательств.

    Если в некоторой теореме мы сможем таким образом переформулировать все гипотезы и само целевое утверждение, то станет возможным использование тактики \textbf{kat}/\textbf{hkat}.
    И если получившееся \textit{KAT}-(не)равенство будет общезначимым или следовать из гипотез Хора, то доказательство будет сгенерировано автоматически.

    Приведем в виде таблицы переформулированные определения:

    \begin{table}[!h]
      \caption{Переформулирование определений}\label{tab1}
      \centering
      \begin{tabularx}{\textwidth}{|*{18}{>{\centering\arraybackslash}X|}}\hline
        Название & Оригинальное определение & \textit{KAT}
        \\\hline
        $ restr\_rel\ p\ r $ & $ r\ x\ y \vee p\ x \vee p\ y $ & $ [p] \cdot r \cdot [p]  $
        \\\hline
        $ clos\_refl\ r $ & &
%        $ irreflexive r $ & & \\\hline
%        $ acyclic $ & & \\\hline
        \\\hline
        $ cross\_rel\ a\ b $ & &
        \\\hline
        $ singl\_rel\ r $  & &
        \\\hline
        $ reflexive\ r $ & &
        \\\hline
        $ transitive\ r $  & &
        \\\hline
        $ upward\_closed\ r\ p $  & &
        \\\hline
        $ dom\_cond\ p $  & &
        \\\hline
        $ max\_elt\ a\ r $ & &
        \\\hline
        $ wmax\_elt\ a\ r $ & &
        \\\hline
        $ min\_elt\ a\ r $ & &
        \\\hline
        $ wmax\_elt\ a\ r $ & &
        \\\hline
      \end{tabularx}
    \end{table}

    \subsection{Использование \textbf{hkat}/\textbf{kat}-тактик}

    После того как мы определили все переформулировки и доказали их корректность, мы можем объединить их в одну тактику $ lift\_to\_kat $,
    которая будет состоять из последовательных переписываний гипотез и цели, пока это возможно.

    А также для удобства можно определить тактики $ kat' $/$ hkat' $, которые будет применять $ lift\_to\_kat $, а потом вызывать $ kat $/$ hkat $.
    Это позволит скрыть все переформулировки за одной тактикой, которая умеет работать со оригинальными определениями и полностью их автоматизирует.

    \begin{lstlisting}[mathescape=true, language=haskell]
    Ltac lift_to_kat :=
       repeat rewrite $ \rightarrow $ restr_rel_iff_kat in *;
       ...
       repeat rewrite $ \rightarrow $ wmax_elt_iff_kat in *.

    Ltac kat'  := lift_to_kat; kat.
    Ltac hkat' := ligt_to_kat; hkat.
    \end{lstlisting}


%    Пример автоматизации доказательства:
%    \begin{lstlisting}[mathescape=true, language=haskell]
%    Lemma add_dom_r A (r: relation A) (s s': A $\rightarrow$ Prop)
%                      (IN: [s'] $\cdot$ r $\subseteq$ r $\cdot$ [s]) :
%      [s'] $\cdot$ r $\equiv$ [s'] $\cdot$ r $\cdot$ [s].
%    Proof.
%    hkat'.
%    (* split. *)
%    (* all: autounfold with unfolderDb in *; ins; desf; eauto. *)
%    (* edestruct IN; eauto. *)
%    Qed.
%    \end{lstlisting}
%    \subsection{Доказательство эквивалентности новых определений}


%    \subsection{Модификация тактик}
  % TODO Написать тут про тактику переписывания и как мы непосредственное доказываем
  % TODO                  проблемы с инстансами
  % TODO                  проблемы с фунциональной/пропозициональной экстенсиональностью
  % TODO                  проблемы с агрегацией гипотез

  \section{Сравнение с существующими решениями}
    % TODO Более точно сравнить с тактиками в Coq: firstorder, (e)auto

    Имея тактики $ kat' $/$ hkat' $ мы можем автоматически доказывать некоторые теоремы и леммы.

    В \textit{hahn} уже были попытки автоматизации доказательств.
    Для этого определен ряд тактик, которые с помощью различных эвристик перебором пытались находить доказательство.

    Проблема таких тактик в том, что они не дают формально критерия, по которому можно было понять сработает тактика или нет.
    А иногда приходится перебирать глубину перебора, чтобы найти оптимальное по времени генерации доказательства решение.

    Наше же решение дает разработчику моделей памяти точный инструмент, для которого есть формально верифицированные гарантии работоспособности.
    Но работает он меньшем числе случаев.

    Так например, даже самое простое утверждение содержание пересечение отношений $ kat' $/$ hkat' $ решить не способно.
    Хотя даже встроенные в Coq тактики автоматизации (\textit{firstorder}) легко с этим справятся.

  \section{Вывод из второй главы TODO}
    В данной главе было представлено решение поставленной задачи и проведено сравнение с альтернативными решениями.

\chapter{Третья глава}
  % NOTE описание, как результаты, полученные во второй главе рализуются на практике
  % NOTE сложности, с которыми столкнулись при реализации

  После доказательства всех аксиом и необходимых для переформулировок утверждений,
  проведено исследование всех доказательств содержащихся в hahn с целью упростить их с помощью нового инструмента.

  % TODO: Уточнить статистику. Например посмотреть на coqwc
  С помощью автоматизации удалось сократить доказательства на 471 сточку, упростились доказательства более 300 теорем/лемм.
%  Из них N получилось полностью доказать с помощью \textbf{kat}, N c помощью \textbf{hkat}.
%  Еще M получилось частично упростить, сокращая порой больше половины доказательства.

  Получилось упростить доказательства связанные со свойствами ацикличности и максимальными/минимальными элементами и отношения.
  Также упростились доказательства связанные с путям (TODO написать, что за пути такие, а за одно и самому узнать).

  \section{Сложности}
    \subsection{Проблемы с применением тактик $kat$/$hkat$}
      Изначально библиотека была спроектирована с использованием наиболее общих интерфейсов.
      Так например, в моноид $ \langle A, \cdot, 1 \rangle $ определяется как множество гетерогенных морфизмов. И аксиомы \textit{KAT} формализованы соответственно.

      % TODO пример, своства где видны кваторы по n m. И что мы не можем их просто так инстациировать.

      Но в нашем случае отношения гомогенные, и морфизмы соответствующего моноида определяются над одним фиксированным типом.
      Это приводит к тому, что типы концов морфизма не используются при объявлении экземпляра канонической структуры \textit{KAT},
      что делает невозможным вывод этих типов из контекста.

      Поэтому пришлось явно указывать эти типы, изменяя реализацию тактик $ kat $/$ hkat $.
      Все эти изменения отразились лишь на реализации тактик $ kat' $/$ hkat'' $

      % TODO: Возможно пример как именно мы это сделали.
    \subsection{Скорость агрегации гипотез}

      Еще одной проблемой стала скорость с которой работает тактика $ hkat $.
      Перед запуском генерации доказательства, она пытается использовать гипотезы.

      Гипотезы поочередно переписываются и объединяются, чтобы привестись к виду $ f \leq 0 $, который может быть использован потом для доказательства целевого утверждения.
      Этот этап называет \textit{агрегацией гипотез.}

      Проблема в том, перебор который происходит в агрегации гипотез может работать десятки, а иногда и минуты.
      Частично с этим можно бороться, удаляя вручную гипотезы из контекста, которые больше не нужны и не помогут для доказательства текущего утверждения.
      Но даже это не сильно улучшает ситуацию.

      Поэтому было принято решение разделить тактику $ hkat' $ на две $ hkat' $ и $ hkat'' $.
      Первая реализует только самые базовые гипотезы, работая при этом не больше одной секунды, и вторая - с полной поддержкой всех гипотез.

      Если все наши переформулировки определений в  \textit{hahn} будут давать сразу в агрегированной форме ($ f \leq 0 $),
      то нам почти всегда будет достаточно $ hkat' $.

      Практика показало, что только 5\% случаев использования $ hkat $ требовали "тяжелой" поддержки $ hkat'' $.

      Также после внимательного анализа была обнаружена возможность оптимизации этапа агрегации путем изменения порядка перебора гипотез.
      Это не изменило результирующего поведения, но позволило ускорить работу $ hkat'' $ на 5-8 секунд.

    \subsection{Баг в агрегации гипотез}

      TODO

  \section{Описание результатов}
    % TODO Написать про статистику

  \section{Выводы из третьей главы TODO}

% \chapter{Заключение}

% \chapter{Список источников}

%\chapter{Приложения}

\end{document}