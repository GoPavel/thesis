\documentclass[times
              %,specification
              %,annotation
              ]{itmo-student-thesis}

\usepackage{amssymb}
\usepackage{mathtools}

\begin{document}
\studygroup{M3439}
\title{Применение теории Клини и ее расширений для автоматизации доказательств в системе Coq  }
\author{Головин Павел Андреевич}{Головин П. А.}
\supervisor{TODO}{TODO}{проф., д.т.н.}{главный научный сотрудник Университета ИТМО}
\publishyear{2020}
%% Дата выдачи задания. Можно не указывать, тогда надо будет заполнить от руки.
%\startdate{01}{сентября}{2018}
%% Срок сдачи студентом работы. Можно не указывать, тогда надо будет заполнить от руки.
%\finishdate{31}{мая}{2019}
%% Дата защиты. Можно не указывать, тогда надо будет заполнить от руки.
%\defencedate{15}{июня}{2019}

%\addconsultant{Белашенков Н.Р.}{канд. физ.-мат. наук, без звания}
%\addconsultant{Беззубик В.В.}{без степени, без звания}

\secretary{Павлова О.Н.}

%% Задание
%%% Техническое задание и исходные данные к работе
\technicalspec{TODO}

%%% Содержание выпускной квалификационной работы (перечень подлежащих разработке вопросов)
\plannedcontents{TODO}

%%% Исходные материалы и пособия
\plannedsources{\begin{enumerate}
    \item TODO
\end{enumerate}}

%%% Цель исследования
\researchaim{TODO}

%%% Задачи, решаемые в ВКР
\researchtargets{\begin{enumerate}
    \item TODO
\end{enumerate}}

%%% Использование современных пакетов компьютерных программ и технологий
%\addadvancedsoftware{Пакет \texttt{tabularx} для чуть более продвинутых таблиц}{\ref{sec:tables}, Приложения~\ref{sec:app:1}, \ref{sec:app:2}}
%\addadvancedsoftware{Пакет \texttt{biblatex} и программное средство \texttt{biber}}{Список использованных источников}

%%% Краткая характеристика полученных результатов
\researchsummary{TODO}

%%% Гранты, полученные при выполнении работы
\researchfunding{TODO}

%%% Наличие публикаций и выступлений на конференциях по теме выпускной работы
\researchpublications{TODO
%  \begin{refsection}
%    Однако покажу, как можно ссылаться на свои публикации из списка литературы:
%    \nocite{example-english, example-russian}
%    \printannobibliography
%  \end{refsection}
}

%% Эта команда генерирует титульный лист и аннотацию.
\maketitle{Бакалавр}

%% Оглавление
\tableofcontents

%% Макрос для введения. Совместим со старым стилевиком.
\startprefacepage

%:Needs:
%      Актуальность работы
%      Цели и задачи работы
%      Новизна работы
%      Практическое значение работы
%      Ссылки на доклады и публикации
%      Краткое описание структуры работы по главам

% ASK Можно ли делать ссылки в введении?

Сегодня компьютерные программы играют большую роль в нашей жизни и все чаще затрагивают такие области как медицина, энергетика, финансы, машиностроение и другие, где огромную роль играет корректность кода.

За последние годы был достигнут большой прогресс в области построения систем интерактивного доказательства теорем, которые позволяют формально верифицировать программы.
Пользователь такой системы должен сначала формализовать программу и ее спецификацию, а потом с помощью специального языка написать доказательство, которое система проверит на корректность.
Примерам таких систем являются Coq(link?), Agda(link?), Isabelle/HOL(link), Idris(link?).

Coq - это один из таких инструментов, который имеет наиболее развитую экосистему и большое сообщество.
Он часто используется для создания верифицированных систем, связанных с компиляцией языков программирования(link to CompCert, Haskell Core Spec, Vellvm) и, в частности, для формализации слабых моделей памяти (link to Victor, Anton).

Модель памяти языка программирования призвана специфицировать поведения параллельных программ в присутствии гонок по данным.
Простые модели памяти могут просто запрещать гонки или гарантировать последовательную согласованность всех операций в программе.

Но такой подход сильно ограничивает параллелизм и мешает компилятору оптимизировать код, от чего сильно страдает производительность программ.
Поэтому на сегодняшний день все языки используют более слабые ограничения (слабые модели памяти).

Такие модели используют бинарные отношения на элементарных событиях чтения и записи, например, отношение синхронизации на атомарных переменных, чтобы выделить только конфликтующие операции и наложить ограничения на возможные исполнения программы.

Проблема заключается в том, что создание формальной слабой модели памяти, которая корректно применима при компиляции программы под разные архитектуры - очень сложная задача, требующая объемных доказательств с аккуратным рассмотрением большого количества случаев.
Поэтому при разработке современных моделей памяти стараются использовать системы интерактивного доказательства теорем (RC11 link?), чтобы упростить написание и проверку доказательств с помощью компьютера.

Так как, работая со слабыми моделям памяти, мы часто имеем дело с бинарными отношениями, то можно попробовать обобщить и вынести (автоматизировать) доказательства утверждений связанные с их свойствами.
Это должно облегчить разработку и исследование слабых моделей памяти в системе Coq.

Алгебра Клини - это алгебраическое обобщение бинарных отношений, регулярных выражений и некоторых других похожих конструкций.
Эта теория хорошо изучена и имеет ряд интересных расширений.
% TODO: Нужны ли тут линки на интересные расширения?

Цель данной работы заключается исследовании перспективности использования Теории алгебры Клини для упрощения формальных доказательств в системе Coq связанных с моделями памяти.
% TODO Альтенативный финал: (Не понятно пока как лучше сформулировать (trade off))
% Цель данной работы заключается исследовании перспективности использования Теории алгебры Клини для упрощения формальных доказательств свойст бинарных отношений в системе Coq.


%% Начало содержательной части.
\chapter{Первая глава}
  % NOTE Первая глава носит обзорны характер.
  %      Тут нужно раскрыть введение и дать точное представление о поставленной задачи
  %      Тут должно быть большинство ссылок на различные источники
  \section{Описание предметной области}

  % План: рассказать, что такое алгебра КАТ, рассказать что про

    % TODO Наверно это не очень важно
    % \subsection(Идемпотентное полу-кольцо)
    %  \textit{Идемпотентное полу-кольцо} - это кортеж $ \langle S, \cdot, +, 1, 0\rangle $

    \subsection{Алгебра отношений}
      Для любого множества $ O $, можно задать \textit{алгебру отношений} $\mathit{Rel}\langle O \rangle \subseteq P(O) $ с операциями:
      \begin{itemize}
        \item композиции ($ \cdot $) и нейтральным элементом <<$1$>>
        \item рефлексивного транзитивного замыкания ($ \_^* $)
      \end{itemize}

      Также мы можем дополнительно определим операции:
      \begin{itemize}
        \item транзитивного замыкания ($ \_^{+} $)
        \item пересечения($ \cap $) и объединения($ \cup $)
        \item инвертирования ($ \_^\smile $) ($ x R y \Leftrightarrow y R^\smile x $)
      \end{itemize}
      и пустое ($0$) и универсальное множество $ \top $

      Алгебра отношений замкнута относительно всех этих операций.

      Для любых двух выражений $ f, e \in \mathit{Rel}$ определим выражение равенства $ f = e $ и неравенства $ f \leq e $, как теоретико-множественные операции равенства и включения множеств соответственно.

      Обозначим за $\mathit{Rel}$ - класс алгебр $ \mathit{Rel}\langle O \rangle $ для всех $ O $,
      а за $ f, e $ - выражения состоящие из конечного количества связок и конечного алфавита атомарных переменных ($ a, b \dots $).

      Тогда (не)равенство этих двух выражений является \textit{общезначимым в классе алгебр отношений}
      ($\mathit{Rel} \models a \leq b, \mathit{Rel} \models a = b $), если они истинны для любой оценки переменных ($a, b \dots $) и любой алгебры $ \mathit{Rel}\langle O \rangle $

    \subsection{Алгебра Клини}
      % TODO (линк на Algebra of Relation)

      Назовем \textit{Алгеброй Клини} кортеж $\langle A,+,\cdot,\_^*,0,1\rangle$ такой, что $\langle A, +, \cdot, 0, 1 \rangle$ - идемпотентное полу-кольцо и операция $ \_^* $ удовлетворяет ряду аксиом:
      \begin{enumerate}
        \item $ 1 + a \cdot a^* \leq a^* $
        \item $ 1 + a^* \cdot a \leq a^* $
        \item $ b + a \cdot x \leq x \Rightarrow a^* \cdot b \leq x $
        \item $ b + x \cdot a \leq x \Rightarrow b \cdot a^* \leq x $
      \end{enumerate}

      Тогда за $ \mathit{KA} $ обозначим аксиоматизированную теорию, состоящую аксиом идемпотентного полу-кольца и аксиом (а-г). % TODO сделать нормальные ссылки

      Записью $ \mathit{KA} \vdash f = g $ будем обозначать факт, что равенство $ f = g $, является логическим следствием аксиом $ \mathit{KA} $

      Для неравенства положим, что $ f \leq g \coloneqq f + g = g$

      Известно, что теория алгебры Клини разрешима и полна относительно алгебры отношений
      ($ Rel \models f = g \Leftrightarrow \mathit{KA} \vdash f = g$) (link?).
      % TODO В последней формуле мы нагло используем одну букву для разных объектов
      Это позволяет нам доказывать общезначимость равенств бинарных отношений через проверку выводимости в $ \mathit{KA} $

    \subsection{Алгебра Клини с тестами}
      Теперь рассмотрим очень полезное расширение KA, алгебры Клини с тестами.
      \textit{Клини алгебра с тестами}, это кортеж $\langle K,\mathbb{B}, [\cdot] \rangle$ такой, что:

      \begin{itemize}
        \item K - Клини алгебра $\langle A, +, \cdot, \_^*, 0, 1 \rangle $
        \item $ \mathbb{B}  $- булева алгебра $\langle B, \wedge, \vee, T, \bot \rangle $
        \item $ [\cdot] $ - гомоморфизм из $\langle A, +, \cdot, \_^*, 0, 1 \rangle  $в $\langle B, \wedge, \vee, T, \bot \rangle$
      \end{itemize}

      Аналогично расширим определение бинарных отношений $Rel \langle O \rangle $, добавив булеву алгебру $\langle P\langle O \rangle, \cap, \cup, O, \emptyset \rangle$ и гомоморфизм $ [a] = \{(p, p) \in a\} $. Сохраним старое обозначения $ \mathit{Rel} $, предполагая, что имеет все необходимые в контексте операции.

      За $ \mathit{KAT} $ обозначим аксиоматическую теорию, состоящую из аксиом \textit{KA}, булевой алгебры $ \mathbb{B}$ и свойств гомоморфизма. И аналогично обозначим за $ KAT \vdash f = g $ выводимость в этой теории.

      Алгебра Клини с тестами полна относительно такой расширенной алгебры бинарных отношений.
      ($\mathit{KAT} \vdash f = g \Leftrightarrow \mathit{Rel} \models f = g$) (link?)
      % TODO (link)

      Элементы булевой алгебры называют обычно называются тестами. Они, например, позволяют нам обогатить наши бинарные отношения предикатами на доменах отношений.
      В моделях памяти это может быть полезно, чтобы определять более сложные свойства исполнения через бинарные отношения.

      % TODO Пример
%    \subsection{Слабая модель памяти}
%      Слабой моделью памяти называются...ге


  \section{Анализ}
     % TODO Что требуется для достижения цели
     % TODO Что уже сделано
     % TODO Почему сделанного недостаточно

  % Поток мыслей: надо написать про то, что уже есть для KAT. Рассказать вообще какие бывают расширение и какие могут быть проблемы. Рассказать, что KAT уже использовали для доказательства корректности компиляции фиксированных схем.
  % Нужно ли писать, что-то про Coq? Наверно нет, это будет ниже

%     Для достижения поставленной цели необходимо реализовать библиотеку, которая формализует и конструктивно доказывает теорему о разрешимости KAT/KA, то есть предоставляет корректный алгоритм построения доказательства равенства двух выражений, если оно общезначимо. После этого необходимо попробовать упростить уже существующие доказательства связанные с моделями памяти, используя эту библиотеку. Но чтобы это сделать необходимо в доказать, что формализация бинарных отношений в упрощаемом код является алгеброй Клини [с тестами].

%     В качестве доказательств необходимых для формализации моделей памяти, было решено взять библиотеку hahn (link), которая содержит в себе базовые определения и леммы, свойственные многим моделям памяти.
  \subsection{Анализ различных расширений алгебр Клини}
    Алгебра Клини будет полезна, чтобы автоматически доказывать утверждения содержащие операции $ \cup, \cdot, \_^* $, а также $ \top, 0, 1 $ и их производные. Например, в утверждении содержащем рефлексивное замыкание отношения $ r $ мы можем использовать вместо замыкания $ r \cup 1 $.

    Алгебра Клини с тестами позволяет нам дополнительно накладывать ограничения домены. Это дает нам возможность выразить переход между фиксированными командами $ a $ и $ b $:
    $ [\lambda x, x = a]\cdot 1 \cdot[\lambda x, x =b] $. Или например факт того, что если какое-то утверждение $ d $ верно в домене, то будет верно и на кодомене отношения можно выразить так: $ [!d] \cdot r \cdot [d] \subseteq 0 $

    В моделях памяти теорема о корректности исполнения формулируется как ацикличность комбинации некоторых других отношений: порядка команд в тексте программ, отношение синхронизации атомарных элементов и т. д. Чтобы выразить ацикличность через Алгебру Клини нам необходимо добавить операцию пересечения $ \cap $. Например так: $ r^* \cap 1 \subseteq 0 $.

    Добавление этой операции делает из нашей алгебры решетку, поэтому такое расширение принято называть Решетки Клини (\textit{KL}). Но проблема в том, алгоритм проверки доказуемости при этом становится EXPSpace-полным(link?).
    Конечные детерминированные автоматы, как и регулярные языки с пересечением не полны относительно алгебры отношений. Это заставляет придумывать более сложные конструкции для построения алгоритмы вывода, такие как автоматы Петри (link?), и сильно усложняет формализацию алгоритма в Coq.

    Поэтому этому пока нет возможности автоматически доказывать теоремы о корректности для моделей памяти целиком.
    %TODO где надо это доказывать? И надо ли?
  \subsection{Анализ существующих реализаций в Coq}

    После анализа уже существующих реализаций в Coq, были найдены две библиотеки attr(link) и relation-algebra(link). При этом первая - это старая версия второй, которая была переработана и оптимизирована, поэтому рассмотрим только последнюю.

    В relation-algebra реализована полная поддержка \textit{KAT} и определена тактика \textbf{kat}, которая позволяет автоматически доказывать (не)равенства.

    Также библиотека имеет тактику \textbf{hkat}, которая позволяет выводить доказательство из гипотез определенного вида. Что является очень полезным на практике. Например, мы можем доказывать монотонность некоторые свойств отношений, то есть если факт того, что если для двух отношений свойство выполняется, то и для их комбинации оно тоже будет выполнено.

    Чтобы использовать эту библиотеку для автоматизации свойств некой структуры нужно доказать, что для нее выполняются все аксиомы $ KAT $. Возможно также придется переформулировать некоторые определения в терминах $ KAT $. В этом случае необходимо также доказать из эквивалентность исходным.


  \section{Постановка задачи}
    % NOTE Текст здесь должен следовать из цели (см. введение)
    % TODO Возможно формулировка того, где мы применяем KAT надо обобщить ?
    % TODO Надо тут сформулировать что-то, к чему потом будет теоритическоре решение
    Необходимо исследовать применимость расширений Теории алгебр Клини, в частности KAT, в доказательствах связанных с моделями памяти.
    Для эксперимента была взята библиотека hahn(link?), которая является базовой для формализации разных слабых моделей памяти.
    % TODO link to hahn, add someting

  \section{Выводы из первой главы}
    В данной главе было сделано введение в предметную область, в которой была выполнена работа, даны необходимые определения и сформулирована задача для дальнейшего решения.
 \chapter{Вторая глава}
 % Needs:
 % TODO Предполагаемое теоретическое решение
 % TODO Обоснование, почему оно удовлетворяет треботваниям, сформулированным в первой главе
 % TODO Теоретическое сравнение с существующими решениями

   \section{Описание решения проблемы}

   Необходимо выполнение всех аксиом в $ KAT $ для определения бинарных отношений которые используются в hahn. Для этого можно использовать стандартные средства интерактивного доказательства которые предоставляет Coq и леммы из relation-algebra.

   Например, в библиотеке уже имеется доказательства того, что встроенный в Coq тип утверждений Prop отвечает аксиомам булевой алгебры, а также лемму о том, что мы можем поточечно расширять алгебраическую структуру. Применив эту лемму к булевой алгебре Prop, мы получим булеву алгебру предикатов $ A \rightarrow Prop $. А применив второй раз, мы получим как раз определения бинарных отношений в hahn $ A \rightarrow A \rightarrow Prop $.

   Чтобы доказывать некоторые свойства и использовать их в качестве гипотез, необходимо переформулировать их в терминах бинарных отношений с тестами. Для этого мы определим новое свойство и докажем, что оно эквивалентно в логическом смысле существующему.

   Например, для утверждения, что $a$ является максимальным элементом в отношении $r$ определяется следующим образом:
   \begin{lstlisting}[float=!h,caption={Определение max\_elt в hahn},label={lst1},mathescape=true]
     Definition max_elt {A: Type} (r: relation) (a: A) :=
       $\forall (b: A)\ (REL: r\ a\ b), \bot$
   \end{lstlisting}
   мы должны доказать лемму:
   \begin{lstlisting}[mathescape=truem]
     Lemma max_elt_iff_kat {A: Type} (a: A) (r: relation A),
       $max\_elt\ r\ a \leftrightarrow [\lambda b \Rightarrow a = b] \cdot r \subseteq \emptyset$
   \end{lstlisting}

    Теперь когда нам нужно доказывать или использовать как гипотезу утверждение $ max\_elt\ r\ a $
    мы можем встроенными средствами Coq(тактикой rewrite) заменить его на $ KAT $-выражение.
    Благодаря такому подходу мы можем не переписывать определения всех теорем и лемм, а изменить только доказательства их. Это сохранит интерфейс библиотеки hahn и не сломает не тронутых доказательств.


    Если в некоторой теореме мы сможешь переформулировать все гипотезы и само целевое утверждение, то стоит ожидать, что relation-algebra автоматически докажет ее.

    Если же переформулировать не получилось, например, если какое-то утверждение содержит пересечение отношений, то возможно отдельные шаги для больших доказательства все же могут быть автоматически доказаны.

  \section{Сравнение с существующими решениями}
    TODO

\chapter{Третья глава}
  % NOTE описание, как результаты, полученные во второй главе рализуются на практике
  % NOTE сложности, с которыми столкнулись при реализации

  После доказательства всех аксиом и необходимых утверждений, чтобы использовать автоматическое доказательство бинарных отношений с тестами было проведено исследование всех доказательств содержащихся в hahn с целью упростить их с помощью нового инструмента.

  Получилось автоматически доказать 471 сточку доказательств в почти 300 теоремах и леммах. Из них N получилось полностью доказать с помощью \textbf{kat}, N c помощью \textbf{hkat}.
  Еще M получилось частично упростить, сокращая порой больше половины доказательства.

  Получилось упростить доказательства связанные со свойствами ацикличности и максимальными/минимальными элементами и отношения.
  Также упростились доказательства связанные с путям (TODO написать, что за пути такие, а за одно и самому узнать).

  \section{Сложности}
    \subsection{Проблемы не работающего вывода типов}
    \subsection{Скорость агрегации гипотез}
    \subsection{Баг в агрегации гипотез}
  \section{Описание результатов}
    % TODO Написать про статистику


% \chapter{Заключение}

% \chapter{Список источников}

%\chapter{Приложения}

\end{document}